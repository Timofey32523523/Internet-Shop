<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог товаров</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="/">TechMarket</a>
            </div>
            <nav class="nav">
                <ul>
                    <li><a href="/">Главная</a></li>
                    <li><a href="/catalog.html" class="active">Каталог</a></li>
                    <li><a href="/cart.html">Корзина <span id="cart-count">0</span></a></li>
                    <li><a href="/account.html">Личный кабинет</a></li>
                    <li><a href="/statistics.html">Статистика</a></li>
                    <li><a href="/analytics.html">Аналитика</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <h1 style="margin-bottom: 30px;">Каталог товаров</h1>

            <!-- Фильтры -->
            <div class="filters">
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="search">Поиск</label>
                        <input type="text" id="search" class="form-control" placeholder="Название товара...">
                    </div>

                    <div class="filter-group">
                        <label for="category">Категория</label>
                        <select id="category" class="form-control">
                            <option value="all">Все категории</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="brand">Бренд</label>
                        <select id="brand" class="form-control">
                            <option value="all">Все бренды</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="min-price">Цена от</label>
                        <input type="number" id="min-price" class="form-control" placeholder="0">
                    </div>

                    <div class="filter-group">
                        <label for="max-price">Цена до</label>
                        <input type="number" id="max-price" class="form-control" placeholder="100000">
                    </div>

                    <div class="filter-group">
                        <label for="sort">Сортировка</label>
                        <select id="sort" class="form-control">
                            <option value="name_asc">По названию (А-Я)</option>
                            <option value="name_desc">По названию (Я-А)</option>
                            <option value="price_asc">Сначала дешевле</option>
                            <option value="price_desc">Сначала дороже</option>
                            <option value="newest">Сначала новые</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button id="apply-filters" class="btn" style="width: 100%;">Применить</button>
                    </div>

                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button id="reset-filters" class="btn btn-secondary" style="width: 100%;">Сбросить</button>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="in-stock"> Только в наличии
                    </label>
                </div>
            </div>

            <!-- Результаты -->
            <div id="results-info" style="margin-bottom: 20px;">
                Найдено товаров: <span id="products-count">0</span>
            </div>

            <div class="product-grid" id="product-grid">
                <div class="text-center">Загрузка...</div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 TechMarket. Все права защищены.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const productGrid = document.getElementById('product-grid');
            const productsCount = document.getElementById('products-count');
            const categorySelect = document.getElementById('category');
            const brandSelect = document.getElementById('brand');
            const searchInput = document.getElementById('search');
            const minPriceInput = document.getElementById('min-price');
            const maxPriceInput = document.getElementById('max-price');
            const sortSelect = document.getElementById('sort');
            const inStockCheckbox = document.getElementById('in-stock');
            const applyBtn = document.getElementById('apply-filters');
            const resetBtn = document.getElementById('reset-filters');

            // Загрузка категорий для фильтра
            async function loadCategories() {
                try {
                    const response = await fetch('/api/categories');
                    const categories = await response.json();

                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Ошибка загрузки категорий:', error);
                }
            }

            // Загрузка брендов для фильтра
            async function loadBrands() {
                try {
                    const response = await fetch('/api/brands');
                    const brands = await response.json();

                    brands.forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand;
                        option.textContent = brand;
                        brandSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Ошибка загрузки брендов:', error);
                }
            }

            // Загрузка товаров
            async function loadProducts() {
                const params = new URLSearchParams();

                if (searchInput.value) params.append('search', searchInput.value);
                if (categorySelect.value !== 'all') params.append('category', categorySelect.value);
                if (brandSelect.value !== 'all') params.append('brand', brandSelect.value);
                if (minPriceInput.value) params.append('minPrice', minPriceInput.value);
                if (maxPriceInput.value) params.append('maxPrice', maxPriceInput.value);
                if (inStockCheckbox.checked) params.append('inStock', 'true');
                if (sortSelect.value) params.append('sort', sortSelect.value);

                try {
                    productGrid.innerHTML = '<div class="text-center">Загрузка...</div>';

                    const response = await fetch(`/api/products?${params.toString()}`);
                    const products = await response.json();

                    productsCount.textContent = products.length;

                    if (products.length === 0) {
                        productGrid.innerHTML = '<div class="alert alert-info">Товары не найдены</div>';
                        return;
                    }

                    let html = '';
                    products.forEach(product => {
                        const inStock = product.in_stock > 0;
                        html += `
                            <div class="product-card">
                                <img src="${product.image_url || 'https://via.placeholder.com/300'}" alt="${product.name}">
                                <h3>${product.name}</h3>
                                <div>
                                    <span class="price">${product.price.toLocaleString()} ₽</span>
                                    ${product.old_price ? `<span class="old-price">${product.old_price.toLocaleString()} ₽</span>` : ''}
                                </div>
                                <p class="description">${product.description.substring(0, 60)}...</p>
                                <p style="color: ${inStock ? '#28a745' : '#dc3545'};">
                                    ${inStock ? `В наличии: ${product.in_stock} шт.` : 'Нет в наличии'}
                                </p>
                                ${inStock ?
                                    `<button class="btn add-to-cart" data-id="${product.id}">В корзину</button>` :
                                    `<button class="btn" disabled>Нет в наличии</button>`
                                }
                                <a href="/product.html?id=${product.id}" class="btn btn-secondary" style="margin-top: 10px;">Подробнее</a>
                            </div>
                        `;
                    });

                    productGrid.innerHTML = html;

                    // Добавляем обработчики на кнопки "В корзину"
                    document.querySelectorAll('.add-to-cart').forEach(button => {
                        button.addEventListener('click', addToCart);
                    });
                } catch (error) {
                    console.error('Ошибка загрузки товаров:', error);
                    productGrid.innerHTML = '<div class="alert alert-error">Ошибка загрузки товаров</div>';
                }
            }

            // Добавление в корзину
            async function addToCart(event) {
                const productId = event.target.dataset.id;

                try {
                    const response = await fetch('/api/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ productId, quantity: 1 }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Товар добавлен в корзину');
                        updateCartCount();
                    } else {
                        if (response.status === 401) {
                            if (confirm('Для добавления в корзину необходимо войти. Перейти на страницу входа?')) {
                                window.location.href = '/account.html';
                            }
                        } else {
                            alert(result.error || 'Ошибка при добавлении');
                        }
                    }
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при добавлении в корзину');
                }
            }

            // Обновление счетчика корзины
            async function updateCartCount() {
                try {
                    const response = await fetch('/api/cart');
                    if (response.ok) {
                        const cart = await response.json();
                        document.getElementById('cart-count').textContent = cart.count;
                    }
                } catch (error) {
                    console.error('Ошибка обновления счетчика:', error);
                }
            }

            // Сброс фильтров
            function resetFilters() {
                searchInput.value = '';
                categorySelect.value = 'all';
                brandSelect.value = 'all';
                minPriceInput.value = '';
                maxPriceInput.value = '';
                sortSelect.value = 'name_asc';
                inStockCheckbox.checked = false;
                loadProducts();
            }

            // Инициализация
            loadCategories();
            loadBrands();
            loadProducts();
            updateCartCount();

            // Обработчики событий
            applyBtn.addEventListener('click', loadProducts);
            resetBtn.addEventListener('click', resetFilters);

            // Поиск при нажатии Enter
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadProducts();
                }
            });
        });
    </script>
</body>
</html>